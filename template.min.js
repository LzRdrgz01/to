// Configuración general
const config = {
  gDriveApikey: "AIzaSyAIpSmdpo48g_EK9kQdcuDKEYJtyqNEGAU",
};

// Función para extraer el ID del enlace Google Drive
function extraerIDDrive(url) {
  // https://drive.google.com/file/d/ID/view
  let regexFile = /\/file\/d\/([^\/]+)\//;
  let match = url.match(regexFile);
  if (match && match[1]) return match[1];

  // https://drive.google.com/open?id=ID
  let regexOpen = /open\?id=([^&]+)/;
  match = url.match(regexOpen);
  if (match && match[1]) return match[1];

  // Si es sólo ID o no coincide, retorna tal cual
  return url;
}

// Cambiar select provider según player
const playerSelect = document.querySelector("select[name=player]");
const providerSelect = document.querySelector("select[name=provider]");
const formatInput = document.querySelector("input[name=format]");

// Activar provider solo para ciertos players
playerSelect.addEventListener("change", () => {
  if (playerSelect.value === "fluidplayer" || playerSelect.value === "jwpl" || playerSelect.value === "plyr") {
    providerSelect.disabled = false;
  } else {
    providerSelect.disabled = true;
    providerSelect.value = "";
  }

  // Actualiza placeholder formato
  if (playerSelect.value === "jwpl") {
    formatInput.value = "video/mp4";
  } else if (playerSelect.value === "plyr") {
    formatInput.value = "video/mp4";
  } else if (playerSelect.value === "fluidplayer") {
    formatInput.value = "video/mp4";
  } else {
    formatInput.value = "";
  }
});

// Tabs lógica simple
const tabs = document.querySelectorAll(".tab-group li");
const tabContents = document.querySelectorAll(".tab-content > div");

tabs.forEach((tab, index) => {
  tab.addEventListener("click", (e) => {
    e.preventDefault();
    // Active tab
    tabs.forEach(t => t.classList.remove("active"));
    tab.classList.add("active");

    // Show content
    tabContents.forEach(tc => (tc.style.display = "none"));
    tabContents[index].style.display = "block";
  });
});

// Manejar formulario submit para generar el código iframe y link
document.querySelector("#signup form").addEventListener("submit", function (e) {
  e.preventDefault();

  const player = this.querySelector("select[name=player]").value;
  const provider = this.querySelector("select[name=provider]").value;
  const linkInput = this.querySelector("input[name=link]").value.trim();

  if (!player) {
    alert("Selecciona un Player.");
    return;
  }
  if ((player !== "video") && !provider) {
    alert("Selecciona un Proveedor.");
    return;
  }
  if (!linkInput) {
    alert("Ingresa el enlace o ID del video.");
    return;
  }

  let videoURL = linkInput;

  // Si es Google Drive, extraemos el ID y creamos URL directa
  if (provider === "gdrive") {
    const idDrive = extraerIDDrive(linkInput);
    videoURL = `https://www.googleapis.com/drive/v3/files/${idDrive}?alt=media&key=${config.gDriveApikey}`;
  }

  // Generar el código según el player seleccionado
  let iframeCode = "";
  switch (player) {
    case "fluidplayer":
      iframeCode = `
        <link href="https://cdn.fluidplayer.com/v3/current/fluidplayer.min.css" rel="stylesheet" />
        <script src="https://cdn.fluidplayer.com/v3/current/fluidplayer.min.js"></script>
        <video id="my-video" class="fluid-player" controls preload="auto" width="640" height="360" poster="" data-setup='{}'>
          <source src="${videoURL}" type="video/mp4" />
        </video>
        <script>
          var player = fluidPlayer("my-video");
        </script>
      `;
      break;

    case "jwpl":
      iframeCode = `
        <div id="jwplayer"></div>
        <script src="https://cdn.jwplayer.com/libraries/IDzF9Zmk.js"></script>
        <script>
          jwplayer("jwplayer").setup({
            file: "${videoURL}",
            width: "100%",
            aspectratio: "16:9"
          });
        </script>
      `;
      break;

    case "plyr":
      iframeCode = `
        <link rel="stylesheet" href="https://cdn.plyr.io/3.7.2/plyr.css" />
        <video id="player" playsinline controls data-poster="">
          <source src="${videoURL}" type="video/mp4" />
        </video>
        <script src="https://cdn.plyr.io/3.7.2/plyr.js"></script>
        <script>
          const player = new Plyr("#player");
        </script>
      `;
      break;

    case "video":
      iframeCode = `<video controls width="100%" height="auto" poster=""><source src="${videoURL}" type="video/mp4"></video>`;
      break;

    default:
      iframeCode = `<p>Player no soportado.</p>`;
  }

  // Mostrar el código generado en la pestaña Código
  document.getElementById("ifcode").value = iframeCode.trim();
  document.getElementById("links").value = videoURL;

  // Cambiar a pestaña código automáticamente
  tabs.forEach(t => t.classList.remove("active"));
  tabs[1].classList.add("active");
  tabContents.forEach(tc => (tc.style.display = "none"));
  tabContents[1].style.display = "block";
});
